<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Evaluation Tool</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background: #f5f7fa;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #2c3e50;
      color: #fff;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-dashboard {
      font-size: 13px;
      font-weight: 600;
      color: #fff;
      background: #3498db;
      padding: 6px 14px;
      border-radius: 6px;
      text-decoration: none;
      transition: background 0.15s;
    }

    .btn-dashboard:hover {
      background: #2980b9;
    }

    #data-file-select {
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    .progress {
      font-size: 14px;
      background: rgba(255,255,255,0.15);
      padding: 6px 14px;
      border-radius: 20px;
    }

    main {
      flex: 1;
      max-width: 800px;
      width: 100%;
      margin: 24px auto;
      padding: 0 16px;
    }

    .nav-info {
      text-align: center;
      font-size: 14px;
      color: #666;
      margin-bottom: 16px;
    }

    .sticky-prompt {
      position: sticky;
      top: 0;
      z-index: 50;
      background: #f5f7fa;
      padding-bottom: 4px;
    }

    .data-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 20px;
    }

    .data-card h2 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
    }

    .data-field {
      margin-bottom: 12px;
    }

    .data-field .label {
      font-size: 12px;
      font-weight: 600;
      color: #7f8c8d;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .data-field .value {
      font-size: 15px;
      line-height: 1.6;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #3498db;
      white-space: pre-wrap;
    }

    .eval-section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 24px;
      margin-bottom: 20px;
    }

    .eval-section h2 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e67e22;
    }

    .eval-item {
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .eval-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .eval-item .criterion-name {
      font-size: 14px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 2px;
    }

    .eval-item .criterion-desc {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 8px;
    }

    .radio-group {
      display: flex;
      gap: 0;
    }

    .radio-group label {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 4px;
      border: 1px solid #ddd;
      margin-left: -1px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
      user-select: none;
      text-align: center;
      gap: 2px;
    }

    .radio-group label .opt-label {
      font-size: 13px;
    }

    .radio-group label .opt-note {
      font-size: 10px;
      opacity: 0.75;
    }

    .radio-group label:first-child {
      border-radius: 6px 0 0 6px;
      margin-left: 0;
    }

    .radio-group label:last-child {
      border-radius: 0 6px 6px 0;
    }

    .radio-group label[data-score="0"] { background: #fdecea; border-color: #f0b4ab; color: #a93226; }
    .radio-group label[data-score="1"] { background: #fef3e6; border-color: #f5cba7; color: #b35c12; }
    .radio-group label[data-score="2"] { background: #fef9e7; border-color: #f7dc6f; color: #7d6608; }
    .radio-group label[data-score="3"] { background: #eafaf1; border-color: #a9dfbf; color: #1e8449; }
    .radio-group label[data-score="4"] { background: #e8f8f5; border-color: #82e0aa; color: #1a7a3a; }

    .radio-group.boolean-group label[data-score="0"] { background: #fdecea; border-color: #f0b4ab; color: #a93226; }
    .radio-group.boolean-group label[data-score="1"] { background: #eafaf1; border-color: #a9dfbf; color: #1e8449; }

    .radio-group label:hover:not(.disabled) {
      z-index: 1;
      filter: brightness(0.95);
    }

    .radio-group label.checked {
      z-index: 2;
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.15);
    }

    .radio-group label.checked[data-score="0"] { background: #e74c3c; border-color: #c0392b; color: #fff; }
    .radio-group label.checked[data-score="1"] { background: #e67e22; border-color: #d35400; color: #fff; }
    .radio-group label.checked[data-score="2"] { background: #f1c40f; border-color: #d4ac0d; color: #333; }
    .radio-group label.checked[data-score="3"] { background: #2ecc71; border-color: #27ae60; color: #fff; }
    .radio-group label.checked[data-score="4"] { background: #27ae60; border-color: #1e8449; color: #fff; }

    .radio-group.boolean-group label.checked[data-score="0"] { background: #e74c3c; border-color: #c0392b; color: #fff; }
    .radio-group.boolean-group label.checked[data-score="1"] { background: #27ae60; border-color: #1e8449; color: #fff; }

    .radio-group label.disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .radio-group input[type="radio"] {
      display: none;
    }

    footer {
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 16px 24px;
      position: sticky;
      bottom: 0;
      z-index: 100;
    }

    .footer-inner {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .nav-buttons {
      display: flex;
      gap: 8px;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, opacity 0.2s;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-nav {
      background: #ecf0f1;
      color: #2c3e50;
    }

    .btn-nav:hover:not(:disabled) {
      background: #d5dbdb;
    }

    .btn-confirm {
      background: #27ae60;
      color: #fff;
    }

    .btn-confirm:hover:not(:disabled) {
      background: #219a52;
    }

    .btn-download {
      background: #3498db;
      color: #fff;
    }

    .btn-download:hover:not(:disabled) {
      background: #2980b9;
    }

    .confirmed-badge {
      display: inline-block;
      font-size: 12px;
      background: #27ae60;
      color: #fff;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }

    .pagination-bar {
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      padding: 12px 16px 0;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .pagination-bar a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 36px;
      padding: 4px 10px;
      border-radius: 6px;
      background: #ecf0f1;
      color: #2c3e50;
      text-decoration: none;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.15s;
    }

    .pagination-bar a:hover {
      background: #d5dbdb;
    }

    .pagination-bar a.active {
      background: #3498db;
      color: #fff;
    }

    .page-selector {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      padding: 16px 0;
    }

    .page-card {
      display: block;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 24px;
      text-decoration: none;
      color: #333;
      transition: box-shadow 0.2s, transform 0.15s;
      text-align: center;
    }

    .page-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .page-card .page-number {
      font-size: 28px;
      font-weight: 700;
      color: #3498db;
      margin-bottom: 8px;
    }

    .page-card .page-range {
      font-size: 13px;
      color: #7f8c8d;
    }

    .page-card .page-status {
      margin-top: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .page-card .page-status.complete {
      color: #27ae60;
    }

    .page-card .page-status.partial {
      color: #e67e22;
    }

    .page-card-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .btn-page-download {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 6px;
      background: #3498db;
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }

    .btn-page-download:hover {
      background: #2980b9;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #999;
      font-size: 16px;
    }

    .error {
      text-align: center;
      padding: 60px;
      color: #e74c3c;
      font-size: 16px;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: row;
        gap: 8px;
        padding: 10px 12px;
      }

      header h1 {
        font-size: 16px;
      }

      .header-right {
        gap: 6px;
      }

      .btn-dashboard {
        font-size: 11px;
        padding: 4px 10px;
      }

      .progress {
        font-size: 11px;
        padding: 4px 10px;
        white-space: nowrap;
      }

      .pagination-bar {
        padding: 8px 12px 0;
        gap: 3px;
      }

      .pagination-bar a {
        min-width: 32px;
        height: 32px;
        font-size: 12px;
        padding: 2px 8px;
      }

      main {
        margin: 8px auto;
        padding: 0 8px;
      }

      .nav-info {
        font-size: 12px;
        margin-bottom: 8px;
      }

      .sticky-prompt {
        padding-bottom: 2px;
      }

      .data-card {
        padding: 10px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
      }

      .data-card h2 {
        font-size: 13px;
        margin-bottom: 6px;
        padding-bottom: 4px;
      }

      .data-field {
        margin-bottom: 0;
      }

      .data-field .label {
        font-size: 10px;
        margin-bottom: 2px;
      }

      .data-field .value {
        font-size: 13px;
        line-height: 1.5;
        padding: 6px 8px;
        max-height: 25vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .eval-section {
        padding: 12px;
        border-radius: 6px;
      }

      .eval-section h2 {
        font-size: 13px;
        margin-bottom: 10px;
        padding-bottom: 4px;
      }

      .eval-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
      }

      .eval-item .criterion-name {
        font-size: 13px;
      }

      .eval-item .criterion-desc {
        font-size: 11px;
        margin-bottom: 6px;
      }

      .radio-group label {
        padding: 10px 2px;
        min-height: 44px;
      }

      .radio-group label .opt-label {
        font-size: 11px;
      }

      .radio-group label .opt-note {
        font-size: 9px;
      }

      footer {
        padding: 10px 12px;
      }

      .footer-inner {
        flex-direction: column;
        gap: 6px;
      }

      .nav-buttons, .action-buttons {
        width: 100%;
      }

      .nav-buttons {
        order: 2;
      }

      .action-buttons {
        order: 1;
      }

      .nav-buttons button, .action-buttons button {
        flex: 1;
        min-height: 44px;
      }

      button {
        padding: 10px 12px;
        font-size: 13px;
      }

      .page-selector {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 8px 0;
      }

      .page-card {
        padding: 16px 12px;
      }

      .page-card .page-number {
        font-size: 22px;
        margin-bottom: 4px;
      }

      .page-card .page-range {
        font-size: 11px;
      }

      .page-card .page-status {
        font-size: 11px;
      }

      .btn-page-download {
        padding: 10px;
        font-size: 12px;
        min-height: 40px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Prompt Evaluation Tool</h1>
    <div class="header-right">
      <a href="analyze.html" class="btn-dashboard">Dashboard</a>
      <select id="data-file-select">
        <option value="data.json">data.json</option>
        <option value="data_2026-02-28_Japanse.json">Japanese (2026-02-28)</option>
        <option value="data_2026-02-28_english.json">English (2026-02-28)</option>
      </select>
      <div class="progress" id="progress">Loading...</div>
    </div>
  </header>

  <nav class="pagination-bar" id="pagination-bar"></nav>

  <main id="main">
    <div class="loading">Loading data...</div>
  </main>

  <footer>
    <div class="footer-inner">
      <div class="nav-buttons">
        <button class="btn-nav" id="btn-prev" disabled>&#9664; Prev</button>
        <button class="btn-nav" id="btn-next" disabled>Next &#9654;</button>
      </div>
      <div class="action-buttons">
        <button class="btn-download" id="btn-download-page" disabled>Download Page</button>
      </div>
    </div>
  </footer>

  <script>
    const ITEMS_PER_PAGE = 10;

    let data = [];
    let config = null;
    let currentPage = null; // null = landing, 1-based page number
    let currentIndex = 0;   // index within current page's items (0-based)
    let results = {};

    function getTotalPages() {
      return Math.ceil(data.length / ITEMS_PER_PAGE);
    }

    function getPageData(page) {
      const start = (page - 1) * ITEMS_PER_PAGE;
      return data.slice(start, start + ITEMS_PER_PAGE);
    }

    function getPageFromHash() {
      const hash = location.hash.replace("#", "");
      const num = parseInt(hash, 10);
      if (isNaN(num) || num < 1 || num > getTotalPages()) return null;
      return num;
    }

    async function init() {
      try {
        const [dataRes, configRes] = await Promise.all([
          fetch(document.getElementById("data-file-select").value),
          fetch("config.json"),
        ]);

        if (!dataRes.ok || !configRes.ok) {
          throw new Error("Failed to load data");
        }

        data = await dataRes.json();
        config = await configRes.json();

        currentPage = getPageFromHash();
        currentIndex = 0;
        renderAll();
      } catch (e) {
        document.getElementById("main").innerHTML =
          '<div class="error">Failed to load data.<br>Please start a local server with: npx serve .</div>';
        document.getElementById("progress").textContent = "Error";
      }
    }

    function renderPaginationBar() {
      const bar = document.getElementById("pagination-bar");
      if (!data.length) { bar.innerHTML = ""; return; }

      const totalPages = getTotalPages();
      const links = [];
      for (let i = 1; i <= totalPages; i++) {
        const activeClass = i === currentPage ? "active" : "";
        links.push(`<a href="#${i}" class="${activeClass}">Page ${i}</a>`);
      }
      bar.innerHTML = links.join("");
    }

    function renderLanding() {
      const totalPages = getTotalPages();
      const confirmedCount = Object.keys(results).length;

      document.getElementById("progress").textContent =
        `Evaluated: ${confirmedCount} / ${data.length}`;

      const cards = [];
      for (let p = 1; p <= totalPages; p++) {
        const pageData = getPageData(p);
        const startNum = (p - 1) * ITEMS_PER_PAGE + 1;
        const endNum = (p - 1) * ITEMS_PER_PAGE + pageData.length;
        const evaluated = pageData.filter(d => results[d.id] !== undefined).length;

        const isPageComplete = evaluated === pageData.length;
        let statusHtml = "";
        if (isPageComplete) {
          statusHtml = `<div class="page-status complete">${evaluated} / ${pageData.length} Complete</div>`;
        } else if (evaluated > 0) {
          statusHtml = `<div class="page-status partial">${evaluated} / ${pageData.length} Evaluated</div>`;
        } else {
          statusHtml = `<div class="page-status">${evaluated} / ${pageData.length} Evaluated</div>`;
        }

        const downloadBtnHtml = isPageComplete
          ? `<button class="btn-page-download" data-page="${p}">Download</button>`
          : "";

        cards.push(`
          <div class="page-card-wrapper">
            <a href="#${p}" class="page-card">
              <div class="page-number">${p}</div>
              <div class="page-range">Items ${startNum} – ${endNum}</div>
              ${statusHtml}
            </a>
            ${downloadBtnHtml}
          </div>
        `);
      }

      document.getElementById("main").innerHTML = `
        <div class="nav-info">Select a page to begin evaluation</div>
        <div class="page-selector">${cards.join("")}</div>
      `;

      document.querySelectorAll(".btn-page-download").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          downloadPageResults(parseInt(btn.dataset.page, 10));
        });
      });

      document.getElementById("btn-prev").disabled = true;
      document.getElementById("btn-next").disabled = true;
      updateButtons();
    }

    function renderItem() {
      const pageData = getPageData(currentPage);
      const item = pageData[currentIndex];
      const confirmedCount = Object.keys(results).length;
      const isLastInPage = currentIndex === pageData.length - 1;
      const isConfirmed = results[item.id] !== undefined;
      const savedEvals = results[item.id]?.evaluations || {};
      const pageEvaluated = pageData.filter(d => results[d.id] !== undefined).length;

      document.getElementById("progress").textContent =
        `Page ${currentPage}: ${pageEvaluated} / ${pageData.length} | Total: ${confirmedCount} / ${data.length}`;

      const promptHtml = `
        <div class="data-field">
          <div class="label">prompt</div>
          <div class="value">${escapeHtml(item.prompt)}</div>
        </div>`;

      const evalItems = config.criteria
        .map((c, ci) => {
          const savedValue = savedEvals[c.name] || "";
          const radios = c.options
            .map(
              (opt, oi) => {
                const val = typeof opt === "string" ? opt : opt.value;
                const note = typeof opt === "string" ? "" : opt.note || "";
                const id = `c${ci}_o${oi}`;
                const checked = val === savedValue ? "checked" : "";
                const disabled = isConfirmed ? "disabled" : "";
                const checkedClass = val === savedValue ? "checked" : "";
                const disabledClass = isConfirmed ? "disabled" : "";
                const noteHtml = note ? `<span class="opt-note">${escapeHtml(note)}</span>` : "";
                return `<label class="${checkedClass} ${disabledClass}" for="${id}" data-score="${oi}">
                  <input type="radio" id="${id}" name="criterion_${ci}" value="${escapeHtml(val)}" ${checked} ${disabled}>
                  <span class="opt-label">${escapeHtml(val)}</span>
                  ${noteHtml}
                </label>`;
              }
            )
            .join("");

          const desc = c.description ? `<div class="criterion-desc">${escapeHtml(c.description)}</div>` : "";
          const groupClass = c.type === "boolean" ? "radio-group boolean-group" : "radio-group";
          return `
          <div class="eval-item" data-criterion="${escapeHtml(c.name)}">
            <div class="criterion-name">${escapeHtml(c.name)}</div>
            ${desc}
            <div class="${groupClass}">${radios}</div>
          </div>`;
        })
        .join("");

      document.getElementById("main").innerHTML = `
        <div class="sticky-prompt">
          <div class="nav-info">
            Page ${currentPage} – Item ${currentIndex + 1} / ${pageData.length} (ID: ${item.id})
            ${isConfirmed ? '<span class="confirmed-badge">Saved</span>' : ""}
          </div>
          <div class="data-card">
            <h2>Prompt</h2>
            ${promptHtml}
          </div>
        </div>
        <div class="eval-section">
          <h2>Evaluation</h2>
          ${evalItems}
        </div>
      `;

      document.querySelectorAll('.radio-group input[type="radio"]').forEach((radio) => {
        radio.addEventListener("change", () => {
          radio.closest(".radio-group").querySelectorAll("label").forEach((lbl) => {
            lbl.classList.toggle("checked", lbl.querySelector("input").checked);
          });
          updateButtons();
        });
      });

      const nextBtn = document.getElementById("btn-next");
      nextBtn.textContent = isLastInPage && !isConfirmed ? "Finish" : "Next \u25B6";

      updateButtons();
    }

    function renderAll() {
      renderPaginationBar();
      if (currentPage === null) {
        renderLanding();
      } else {
        renderItem();
      }
    }

    function saveCurrentEvaluations() {
      const pageData = getPageData(currentPage);
      const item = pageData[currentIndex];
      results[item.id] = {
        id: item.id,
        evaluations: getEvaluations(),
      };
    }

    function updateButtons() {
      const prevBtn = document.getElementById("btn-prev");
      const nextBtn = document.getElementById("btn-next");
      const downloadPageBtn = document.getElementById("btn-download-page");

      if (currentPage === null) {
        downloadPageBtn.disabled = true;
        downloadPageBtn.textContent = "Download Page";
        return;
      }

      const pageData = getPageData(currentPage);
      const item = pageData[currentIndex];
      const isConfirmed = results[item.id] !== undefined;
      const allSelected = allCriteriaSelected();
      const isLastInPage = currentIndex === pageData.length - 1;

      prevBtn.disabled = currentIndex === 0;

      if (isConfirmed && isLastInPage) {
        nextBtn.disabled = true;
      } else if (isConfirmed) {
        nextBtn.disabled = false;
      } else {
        nextBtn.disabled = !allSelected;
      }

      const pageDone = pageData.every((d) => results[d.id] !== undefined);
      downloadPageBtn.disabled = !pageDone;
      downloadPageBtn.textContent = `Download Page ${currentPage}`;
    }

    function allCriteriaSelected() {
      const groups = document.querySelectorAll(".eval-item");
      if (groups.length === 0) return false;
      return Array.from(groups).every((g) =>
        g.querySelector('input[type="radio"]:checked')
      );
    }

    function getEvaluations() {
      const evals = {};
      document.querySelectorAll(".eval-item").forEach((g) => {
        const name = g.getAttribute("data-criterion");
        const checked = g.querySelector('input[type="radio"]:checked');
        evals[name] = checked ? checked.value : "";
      });
      return evals;
    }

    function escapeHtml(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    document.getElementById("btn-prev").addEventListener("click", () => {
      if (currentPage === null) return;
      if (currentIndex > 0) {
        currentIndex--;
        renderAll();
      }
    });

    document.getElementById("btn-next").addEventListener("click", () => {
      if (currentPage === null) return;
      const pageData = getPageData(currentPage);
      const item = pageData[currentIndex];
      const isConfirmed = results[item.id] !== undefined;

      if (!isConfirmed) {
        if (!allCriteriaSelected()) return;
        saveCurrentEvaluations();
      }

      if (currentIndex < pageData.length - 1) {
        currentIndex++;
      }

      renderAll();
    });

    function downloadJson(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function toNumericValue(criterion, value) {
      const c = config.criteria.find((cr) => cr.name === criterion);
      if (!c) return value;
      if (c.type === "boolean") {
        return value === "Yes" ? 1 : 0;
      }
      const num = parseInt(value, 10);
      return isNaN(num) ? value : num;
    }

    function toNumericEvaluations(evals) {
      const out = {};
      for (const [key, val] of Object.entries(evals)) {
        out[key] = toNumericValue(key, val);
      }
      return out;
    }

    function downloadPageResults(page) {
      const pageData = getPageData(page);
      const output = pageData.map((d) => ({
        id: results[d.id].id,
        evaluations: toNumericEvaluations(results[d.id].evaluations),
      }));
      downloadJson(output, `evaluation_results_page${page}.json`);
    }

    document.getElementById("btn-download-page").addEventListener("click", () => {
      if (currentPage === null) return;
      downloadPageResults(currentPage);
    });

    window.addEventListener("hashchange", () => {
      if (!data.length) return;
      currentPage = getPageFromHash();
      currentIndex = 0;
      renderAll();
    });

    init();

    document.getElementById("data-file-select").addEventListener("change", init);
  </script>
</body>
</html>
