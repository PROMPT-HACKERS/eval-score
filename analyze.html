<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Evaluation Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }
    header {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-bottom: 1px solid #334155;
      padding: 24px 40px;
    }
    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      color: #f8fafc;
    }
    header p {
      color: #94a3b8;
      margin-top: 4px;
      font-size: 0.95rem;
    }
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    /* Summary cards */
    .summary-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 20px;
    }
    .card-sm {
      text-align: center;
    }
    .card-sm .label {
      font-size: 0.8rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .card-sm .value {
      font-size: 2rem;
      font-weight: 700;
      margin-top: 4px;
    }
    .card-sm .sub {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 2px;
    }

    /* Chart grid */
    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    .chart-grid .card { padding: 24px; }
    .card h2 {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: #f1f5f9;
    }
    .chart-container {
      position: relative;
      width: 100%;
    }
    .chart-container canvas {
      width: 100% !important;
    }

    /* Full-width sections */
    .full-width {
      margin-bottom: 32px;
    }
    .full-width .card {
      padding: 24px;
    }

    /* Heatmap table */
    .heatmap-wrapper {
      overflow-x: auto;
    }
    .heatmap {
      width: 100%;
      border-collapse: separate;
      border-spacing: 3px;
      font-size: 0.85rem;
    }
    .heatmap th {
      padding: 8px 12px;
      text-align: center;
      color: #94a3b8;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .heatmap th.row-header {
      text-align: left;
      min-width: 100px;
    }
    .heatmap td {
      padding: 10px 8px;
      text-align: center;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: transform 0.15s;
    }
    .heatmap td:hover {
      transform: scale(1.1);
      z-index: 1;
    }
    .heatmap td.row-label {
      text-align: left;
      background: transparent !important;
      color: #cbd5e1;
      font-weight: 500;
    }
    .evaluator-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .evaluator-tabs button {
      padding: 8px 20px;
      border: 1px solid #475569;
      border-radius: 8px;
      background: transparent;
      color: #94a3b8;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .evaluator-tabs button.active {
      background: #3b82f6;
      border-color: #3b82f6;
      color: #fff;
    }
    .evaluator-tabs button:hover:not(.active) {
      border-color: #64748b;
      color: #e2e8f0;
    }

    /* Evaluator comparison table */
    .compare-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .compare-table th {
      padding: 10px 12px;
      text-align: center;
      color: #94a3b8;
      border-bottom: 1px solid #334155;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
    }
    .compare-table th:first-child {
      text-align: left;
    }
    .compare-table td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #1e293b;
    }
    .compare-table td:first-child {
      text-align: left;
      color: #cbd5e1;
      font-weight: 500;
    }
    .compare-table tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }
    .bar-cell {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .mini-bar {
      height: 6px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    /* Legend */
    .legend {
      display: flex;
      gap: 24px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: #94a3b8;
    }
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    /* Per-prompt section */
    .section-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 8px;
      margin-top: 16px;
    }
    .section-desc {
      font-size: 0.9rem;
      color: #94a3b8;
      margin-bottom: 20px;
    }
    .prompt-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .prompt-card {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 20px;
    }
    .prompt-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .prompt-card-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #f1f5f9;
    }
    .prompt-card-header .total-badge {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }
    .prompt-card .score-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 12px;
    }
    .prompt-card .score-table th {
      padding: 6px 8px;
      text-align: center;
      color: #64748b;
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      border-bottom: 1px solid #334155;
    }
    .prompt-card .score-table th:first-child { text-align: left; }
    .prompt-card .score-table td {
      padding: 5px 8px;
      text-align: center;
      color: #cbd5e1;
    }
    .prompt-card .score-table td:first-child {
      text-align: left;
      color: #94a3b8;
      font-weight: 500;
    }
    .prompt-card .score-table tr:last-child td {
      border-top: 1px solid #334155;
      font-weight: 600;
    }
    .score-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      vertical-align: middle;
    }
    .prompt-card .chart-container {
      height: 260px;
    }
    .prompt-card .chart-container canvas {
      height: 100% !important;
    }
    .view-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .view-toggle button {
      padding: 8px 20px;
      border: 1px solid #475569;
      border-radius: 8px;
      background: transparent;
      color: #94a3b8;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .view-toggle button.active {
      background: #8b5cf6;
      border-color: #8b5cf6;
      color: #fff;
    }
    .view-toggle button:hover:not(.active) {
      border-color: #64748b;
      color: #e2e8f0;
    }

    .diff-positive { background: rgba(59,130,246,0.7); color: #fff; }
    .diff-negative { background: rgba(239,68,68,0.7); color: #fff; }
    .diff-zero { background: rgba(100,116,139,0.4); color: #cbd5e1; }

    /* Responsive */
    @media (max-width: 900px) {
      .chart-grid { grid-template-columns: 1fr; }
      .prompt-grid { grid-template-columns: 1fr; }
      header { padding: 20px; }
      .dashboard { padding: 20px 16px; }
    }
  </style>
</head>
<body>

<header>
  <h1>Prompt Evaluation Dashboard</h1>
  <p id="headerDesc">Loading...</p>
</header>

<div class="dashboard">

  <!-- Summary Cards -->
  <div class="summary-row" id="summaryCards"></div>

  <!-- Chart Grid: Human Avg vs Mistral -->
  <div class="chart-grid">
    <div class="card">
      <h2>Radar - Human Avg vs Mistral</h2>
      <div class="chart-container">
        <canvas id="radarChart"></canvas>
      </div>
    </div>
    <div class="card">
      <h2>Criteria Difference (Mistral - Human Avg)</h2>
      <div class="chart-container">
        <canvas id="diffChart"></canvas>
      </div>
    </div>
    <div class="card">
      <h2>Total Score per Prompt</h2>
      <div class="chart-container">
        <canvas id="barChart"></canvas>
      </div>
    </div>
    <div class="card">
      <h2>Score Distribution</h2>
      <div class="chart-container">
        <canvas id="distributionChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Difference Heatmap -->
  <div class="full-width">
    <div class="card">
      <h2>Difference Heatmap (Mistral - Human Avg)</h2>
      <div class="heatmap-wrapper">
        <table class="heatmap" id="diffHeatmap"></table>
      </div>
    </div>
  </div>

  <!-- Score Heatmap -->
  <div class="full-width">
    <div class="card">
      <h2>Score Heatmap</h2>
      <div class="evaluator-tabs" id="heatmapTabs"></div>
      <div class="heatmap-wrapper">
        <table class="heatmap" id="heatmapTable"></table>
      </div>
    </div>
  </div>

  <!-- Per-Prompt Detail -->
  <div class="full-width">
    <h2 class="section-title">Per-Prompt Detail</h2>
    <p class="section-desc">Human Avg vs Mistral for each prompt</p>
    <div class="prompt-grid" id="promptGrid"></div>
  </div>

  <!-- All evaluators radar -->
  <div class="full-width">
    <div class="card">
      <h2>All Evaluators - Criteria Average</h2>
      <div class="chart-container">
        <canvas id="allRadarChart"></canvas>
      </div>
    </div>
  </div>

</div>

<script>
const EVALUATOR_COLORS = {
  'Default':  { bg: 'rgba(59,130,246,0.7)',  border: '#3b82f6',  light: 'rgba(59,130,246,0.15)' },
  'Aizawa':   { bg: 'rgba(16,185,129,0.7)',  border: '#10b981',  light: 'rgba(16,185,129,0.15)' },
  'Shimada':  { bg: 'rgba(244,114,182,0.7)', border: '#f472b6',  light: 'rgba(244,114,182,0.15)' },
  'Mistral':  { bg: 'rgba(251,191,36,0.7)',  border: '#fbbf24',  light: 'rgba(251,191,36,0.15)' },
};

const HUMAN_COLOR   = { bg: 'rgba(16,185,129,0.7)',  border: '#10b981', light: 'rgba(16,185,129,0.15)' };
const MISTRAL_COLOR = { bg: 'rgba(251,191,36,0.7)',  border: '#fbbf24', light: 'rgba(251,191,36,0.15)' };

const CRITERIA = [
  'Clarity', 'Role Assignment', 'Prompt Structure Order',
  'Target Audience', 'Scope Limitation', 'Output Format', 'Example / Template'
];

const CRITERIA_SHORT = [
  'Clarity', 'Role', 'Structure', 'Audience', 'Scope', 'Format', 'Example'
];

let allData = {};
const HUMAN_EVALUATORS = ['Default', 'Aizawa', 'Shimada'];

// ── Load data ────────────────────────────────────────────
async function loadData() {
  const files = {
    'Default':  'data/evaluation_results_page1.json',
    'Aizawa':   'data/evaluation_results_page1_aizawa.json',
    'Shimada':  'data/evaluation_results_page1_Shimada.json',
    'Mistral':  'data/evaluation_results_page1_from_mistral.json',
  };
  for (const [name, path] of Object.entries(files)) {
    const res = await fetch(path);
    allData[name] = await res.json();
  }
}

// ── Helpers ──────────────────────────────────────────────
function avg(arr) { return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0; }

function criteriaAvg(data, criterion) {
  return avg(data.map(d => d.evaluations[criterion]));
}

function totalScore(entry) {
  return Object.values(entry.evaluations).reduce((a, b) => a + b, 0);
}

function humanAvgForPrompt(i, criterion) {
  return avg(HUMAN_EVALUATORS.map(e => allData[e][i].evaluations[criterion]));
}

function humanAvgTotal(i) {
  return avg(HUMAN_EVALUATORS.map(e => totalScore(allData[e][i])));
}

function heatColor(val, max = 5) {
  const ratio = val / max;
  if (ratio <= 0.2) return 'rgba(239,68,68,0.8)';
  if (ratio <= 0.4) return 'rgba(249,115,22,0.8)';
  if (ratio <= 0.6) return 'rgba(234,179,8,0.75)';
  if (ratio <= 0.8) return 'rgba(34,197,94,0.7)';
  return 'rgba(16,185,129,0.85)';
}

function diffColor(diff) {
  const abs = Math.abs(diff);
  const alpha = Math.min(abs / 3, 1) * 0.7 + 0.15;
  if (diff > 0.05) return `rgba(59,130,246,${alpha})`;
  if (diff < -0.05) return `rgba(239,68,68,${alpha})`;
  return 'rgba(100,116,139,0.4)';
}

// ── Header ──────────────────────────────────────────────
function renderHeader() {
  const count = allData[HUMAN_EVALUATORS[0]].length;
  const evaluators = Object.keys(allData).length;
  document.getElementById('headerDesc').textContent =
    `${evaluators} Evaluators (${HUMAN_EVALUATORS.length} Human + Mistral) / ${count} Prompts / ${CRITERIA.length} Criteria`;
}

// ── Summary Cards ────────────────────────────────────────
function renderSummary() {
  const container = document.getElementById('summaryCards');
  const count = allData[HUMAN_EVALUATORS[0]].length;
  const maxTotal = CRITERIA.length * 5;

  const humanOverall = avg(CRITERIA.map(c => avg(HUMAN_EVALUATORS.map(e => criteriaAvg(allData[e], c)))));
  const mistralOverall = avg(CRITERIA.map(c => criteriaAvg(allData['Mistral'], c)));
  const overallDiff = (mistralOverall - humanOverall).toFixed(2);
  const diffSign = overallDiff > 0 ? '+' : '';

  // Biggest positive/negative diff by criterion
  const critDiffs = CRITERIA.map((c, i) => {
    const hAvg = avg(HUMAN_EVALUATORS.map(e => criteriaAvg(allData[e], c)));
    const mAvg = criteriaAvg(allData['Mistral'], c);
    return { name: CRITERIA_SHORT[i], diff: mAvg - hAvg };
  });
  const maxPosDiff = critDiffs.reduce((a, b) => a.diff > b.diff ? a : b);
  const maxNegDiff = critDiffs.reduce((a, b) => a.diff < b.diff ? a : b);

  // Correlation: how many prompts Mistral agrees with human avg (within 1 point total)
  const agreeCount = Array.from({ length: count }, (_, i) => {
    const hTotal = humanAvgTotal(i);
    const mTotal = totalScore(allData['Mistral'][i]);
    return Math.abs(mTotal - hTotal) <= CRITERIA.length ? 1 : 0;
  }).reduce((a, b) => a + b, 0);

  const cards = [
    { label: 'Human Avg', value: humanOverall.toFixed(2), sub: '/ 5.00' },
    { label: 'Mistral Avg', value: mistralOverall.toFixed(2), sub: '/ 5.00' },
    { label: 'Overall Diff', value: `${diffSign}${overallDiff}`, sub: 'Mistral - Human' },
    { label: 'Most Overrated', value: `+${maxPosDiff.diff.toFixed(2)}`, sub: maxPosDiff.name },
    { label: 'Most Underrated', value: maxNegDiff.diff.toFixed(2), sub: maxNegDiff.name },
  ];

  container.innerHTML = cards.map(c => `
    <div class="card card-sm">
      <div class="label">${c.label}</div>
      <div class="value">${c.value}</div>
      <div class="sub">${c.sub}</div>
    </div>
  `).join('');
}

// ── Radar: Human Avg vs Mistral ─────────────────────────
function renderRadar() {
  const humanData = CRITERIA.map(c => avg(HUMAN_EVALUATORS.map(e => criteriaAvg(allData[e], c))));
  const mistralData = CRITERIA.map(c => criteriaAvg(allData['Mistral'], c));

  new Chart(document.getElementById('radarChart'), {
    type: 'radar',
    data: {
      labels: CRITERIA_SHORT,
      datasets: [
        {
          label: 'Human Avg',
          data: humanData,
          backgroundColor: HUMAN_COLOR.light,
          borderColor: HUMAN_COLOR.border,
          borderWidth: 2,
          pointBackgroundColor: HUMAN_COLOR.border,
          pointRadius: 4,
        },
        {
          label: 'Mistral',
          data: mistralData,
          backgroundColor: MISTRAL_COLOR.light,
          borderColor: MISTRAL_COLOR.border,
          borderWidth: 2,
          pointBackgroundColor: MISTRAL_COLOR.border,
          pointRadius: 4,
        },
      ],
    },
    options: {
      scales: {
        r: {
          min: 0, max: 5,
          ticks: { stepSize: 1, color: '#64748b', backdropColor: 'transparent' },
          grid: { color: '#334155' },
          pointLabels: { color: '#cbd5e1', font: { size: 12 } },
          angleLines: { color: '#334155' },
        }
      },
      plugins: {
        legend: { labels: { color: '#cbd5e1', usePointStyle: true, pointStyle: 'circle' } }
      },
      responsive: true,
      maintainAspectRatio: true,
    }
  });
}

// ── Diff Chart: Mistral - Human Avg per Criterion ───────
function renderDiffChart() {
  const diffs = CRITERIA.map(c => {
    const hAvg = avg(HUMAN_EVALUATORS.map(e => criteriaAvg(allData[e], c)));
    const mAvg = criteriaAvg(allData['Mistral'], c);
    return +(mAvg - hAvg).toFixed(2);
  });

  new Chart(document.getElementById('diffChart'), {
    type: 'bar',
    data: {
      labels: CRITERIA_SHORT,
      datasets: [{
        label: 'Mistral - Human Avg',
        data: diffs,
        backgroundColor: diffs.map(d => d >= 0 ? 'rgba(59,130,246,0.7)' : 'rgba(239,68,68,0.7)'),
        borderRadius: 4,
      }]
    },
    options: {
      indexAxis: 'y',
      scales: {
        x: {
          ticks: { color: '#94a3b8' },
          grid: { color: '#1e293b' },
          title: { display: true, text: 'Difference', color: '#94a3b8' },
        },
        y: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const v = ctx.raw;
              return v >= 0 ? `Mistral +${v} (higher)` : `Mistral ${v} (lower)`;
            }
          }
        }
      },
      responsive: true,
    }
  });
}

// ── Bar Chart: Total Score per Prompt ────────────────────
function renderBarChart() {
  const count = allData[HUMAN_EVALUATORS[0]].length;
  const ids = allData[HUMAN_EVALUATORS[0]].map(d => `#${d.id}`);

  new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: {
      labels: ids,
      datasets: [
        {
          label: 'Human Avg',
          data: Array.from({ length: count }, (_, i) => +humanAvgTotal(i).toFixed(1)),
          backgroundColor: HUMAN_COLOR.bg,
          borderColor: HUMAN_COLOR.border,
          borderWidth: 1,
          borderRadius: 4,
        },
        {
          label: 'Mistral',
          data: allData['Mistral'].map(d => totalScore(d)),
          backgroundColor: MISTRAL_COLOR.bg,
          borderColor: MISTRAL_COLOR.border,
          borderWidth: 1,
          borderRadius: 4,
        },
      ],
    },
    options: {
      scales: {
        x: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } },
        y: { min: 0, max: 35, ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } }
      },
      plugins: {
        legend: { labels: { color: '#cbd5e1', usePointStyle: true, pointStyle: 'circle' } }
      },
      responsive: true,
    }
  });
}

// ── Distribution Chart ──────────────────────────────────
function renderDistribution() {
  const humanCounts = [0, 0, 0, 0, 0, 0];
  const mistralCounts = [0, 0, 0, 0, 0, 0];

  HUMAN_EVALUATORS.forEach(name => {
    allData[name].forEach(d => {
      Object.values(d.evaluations).forEach(v => humanCounts[v]++);
    });
  });
  allData['Mistral'].forEach(d => {
    Object.values(d.evaluations).forEach(v => mistralCounts[v]++);
  });
  // Normalize human counts to per-evaluator average
  const humanNorm = humanCounts.map(c => +(c / HUMAN_EVALUATORS.length).toFixed(1));

  new Chart(document.getElementById('distributionChart'), {
    type: 'bar',
    data: {
      labels: ['0', '1', '2', '3', '4', '5'],
      datasets: [
        {
          label: 'Human Avg',
          data: humanNorm,
          backgroundColor: HUMAN_COLOR.bg,
          borderColor: HUMAN_COLOR.border,
          borderWidth: 1,
          borderRadius: 4,
        },
        {
          label: 'Mistral',
          data: mistralCounts,
          backgroundColor: MISTRAL_COLOR.bg,
          borderColor: MISTRAL_COLOR.border,
          borderWidth: 1,
          borderRadius: 4,
        },
      ],
    },
    options: {
      scales: {
        x: { title: { display: true, text: 'Score', color: '#94a3b8' }, ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } },
        y: { title: { display: true, text: 'Count', color: '#94a3b8' }, ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } }
      },
      plugins: {
        legend: { labels: { color: '#cbd5e1', usePointStyle: true, pointStyle: 'circle' } }
      },
      responsive: true,
    }
  });
}

// ── Diff Heatmap ─────────────────────────────────────────
function renderDiffHeatmap() {
  const table = document.getElementById('diffHeatmap');
  const count = allData[HUMAN_EVALUATORS[0]].length;
  const ids = allData[HUMAN_EVALUATORS[0]].map(d => d.id);

  let html = '<thead><tr><th class="row-header">Criterion</th>';
  ids.forEach(id => html += `<th>#${id}</th>`);
  html += '<th>Avg Diff</th></tr></thead><tbody>';

  CRITERIA.forEach((c, ci) => {
    html += `<tr><td class="row-label">${CRITERIA_SHORT[ci]}</td>`;
    const diffs = [];
    ids.forEach((id, i) => {
      const hAvg = humanAvgForPrompt(i, c);
      const mVal = allData['Mistral'][i].evaluations[c];
      const diff = mVal - hAvg;
      diffs.push(diff);
      const sign = diff > 0 ? '+' : '';
      html += `<td style="background:${diffColor(diff)};color:#fff">${sign}${diff.toFixed(1)}</td>`;
    });
    const avgDiff = avg(diffs);
    const sign = avgDiff > 0 ? '+' : '';
    html += `<td style="background:${diffColor(avgDiff)};color:#fff"><strong>${sign}${avgDiff.toFixed(2)}</strong></td>`;
    html += '</tr>';
  });

  // Total row
  html += '<tr><td class="row-label"><strong>Total</strong></td>';
  const totalDiffs = [];
  ids.forEach((id, i) => {
    const hTotal = humanAvgTotal(i);
    const mTotal = totalScore(allData['Mistral'][i]);
    const diff = mTotal - hTotal;
    totalDiffs.push(diff);
    const sign = diff > 0 ? '+' : '';
    html += `<td style="background:${diffColor(diff / CRITERIA.length)};color:#fff"><strong>${sign}${diff.toFixed(1)}</strong></td>`;
  });
  const grandDiff = avg(totalDiffs);
  const sign = grandDiff > 0 ? '+' : '';
  html += `<td style="background:${diffColor(grandDiff / CRITERIA.length)};color:#fff"><strong>${sign}${grandDiff.toFixed(1)}</strong></td>`;
  html += '</tr></tbody>';
  table.innerHTML = html;
}

// ── Score Heatmap ────────────────────────────────────────
let currentHeatmap = 'Human Avg';

function renderHeatmapTabs() {
  const tabs = document.getElementById('heatmapTabs');
  const names = ['Human Avg', ...Object.keys(allData)];
  tabs.innerHTML = names.map(name =>
    `<button class="${name === currentHeatmap ? 'active' : ''}" onclick="switchHeatmap('${name}')">${name}</button>`
  ).join('');
}

function switchHeatmap(name) {
  currentHeatmap = name;
  renderHeatmapTabs();
  renderHeatmap();
}

function renderHeatmap() {
  const table = document.getElementById('heatmapTable');
  const evaluators = Object.keys(allData);
  const ids = allData[HUMAN_EVALUATORS[0]].map(d => d.id);

  let html = '<thead><tr><th class="row-header">Criterion</th>';
  ids.forEach(id => html += `<th>#${id}</th>`);
  html += '<th>Avg</th></tr></thead><tbody>';

  CRITERIA.forEach((c, ci) => {
    html += `<tr><td class="row-label">${CRITERIA_SHORT[ci]}</td>`;
    ids.forEach((id, i) => {
      let val;
      if (currentHeatmap === 'Human Avg') {
        val = humanAvgForPrompt(i, c);
      } else {
        val = allData[currentHeatmap][i].evaluations[c];
      }
      const display = currentHeatmap === 'Human Avg' ? val.toFixed(1) : val;
      html += `<td style="background:${heatColor(val)};color:#fff">${display}</td>`;
    });
    const rowAvg = avg(ids.map((_, i) => {
      if (currentHeatmap === 'Human Avg') return humanAvgForPrompt(i, c);
      return allData[currentHeatmap][i].evaluations[c];
    }));
    html += `<td style="background:${heatColor(rowAvg)};color:#fff">${rowAvg.toFixed(1)}</td>`;
    html += '</tr>';
  });

  html += '<tr><td class="row-label"><strong>Total</strong></td>';
  ids.forEach((id, i) => {
    let val;
    if (currentHeatmap === 'Human Avg') {
      val = humanAvgTotal(i);
    } else {
      val = totalScore(allData[currentHeatmap][i]);
    }
    const display = currentHeatmap === 'Human Avg' ? val.toFixed(1) : val;
    html += `<td style="background:${heatColor(val / CRITERIA.length)};color:#fff"><strong>${display}</strong></td>`;
  });
  const grandAvg = avg(ids.map((_, i) => {
    if (currentHeatmap === 'Human Avg') return humanAvgTotal(i);
    return totalScore(allData[currentHeatmap][i]);
  }));
  html += `<td style="background:${heatColor(grandAvg / CRITERIA.length)};color:#fff"><strong>${grandAvg.toFixed(1)}</strong></td>`;
  html += '</tr></tbody>';
  table.innerHTML = html;
}

// ── Per-Prompt Detail ────────────────────────────────────
let perPromptCharts = [];

function renderPerPrompt() {
  const grid = document.getElementById('promptGrid');
  const count = allData[HUMAN_EVALUATORS[0]].length;

  perPromptCharts.forEach(c => c.destroy());
  perPromptCharts = [];

  let html = '';
  for (let i = 0; i < count; i++) {
    const id = allData[HUMAN_EVALUATORS[0]][i].id;
    const hTotal = humanAvgTotal(i);
    const mTotal = totalScore(allData['Mistral'][i]);
    const diff = mTotal - hTotal;
    const diffSign = diff > 0 ? '+' : '';

    html += `
      <div class="prompt-card">
        <div class="prompt-card-header">
          <h3>Prompt #${id}</h3>
          <span class="total-badge" style="color:${diff >= 0 ? '#3b82f6' : '#ef4444'};background:${diff >= 0 ? 'rgba(59,130,246,0.15)' : 'rgba(239,68,68,0.15)'}">
            Diff ${diffSign}${diff.toFixed(1)}
          </span>
        </div>
        <div class="chart-container">
          <canvas id="promptChart${i}"></canvas>
        </div>
        <table class="score-table">
          <thead>
            <tr><th>Criterion</th><th>Human</th><th>Mistral</th><th>Diff</th></tr>
          </thead>
          <tbody>
            ${CRITERIA.map((c, ci) => {
              const hAvg = humanAvgForPrompt(i, c);
              const mVal = allData['Mistral'][i].evaluations[c];
              const d = mVal - hAvg;
              const ds = d > 0 ? '+' : '';
              const dc = d > 0.05 ? '#3b82f6' : d < -0.05 ? '#ef4444' : '#94a3b8';
              return `<tr>
                <td>${CRITERIA_SHORT[ci]}</td>
                <td>${hAvg.toFixed(1)}</td>
                <td>${mVal}</td>
                <td style="color:${dc};font-weight:600">${ds}${d.toFixed(1)}</td>
              </tr>`;
            }).join('')}
            <tr>
              <td>Total</td>
              <td>${hTotal.toFixed(1)}</td>
              <td>${mTotal}</td>
              <td style="color:${diff >= 0 ? '#3b82f6' : '#ef4444'};font-weight:600">${diffSign}${diff.toFixed(1)}</td>
            </tr>
          </tbody>
        </table>
      </div>`;
  }
  grid.innerHTML = html;

  for (let i = 0; i < count; i++) {
    const canvas = document.getElementById(`promptChart${i}`);
    const humanScores = CRITERIA.map(c => humanAvgForPrompt(i, c));
    const mistralScores = CRITERIA.map(c => allData['Mistral'][i].evaluations[c]);

    const chart = new Chart(canvas, {
      type: 'radar',
      data: {
        labels: CRITERIA_SHORT,
        datasets: [
          {
            label: 'Human Avg',
            data: humanScores,
            backgroundColor: HUMAN_COLOR.light,
            borderColor: HUMAN_COLOR.border,
            borderWidth: 2,
            pointBackgroundColor: HUMAN_COLOR.border,
            pointRadius: 3,
          },
          {
            label: 'Mistral',
            data: mistralScores,
            backgroundColor: MISTRAL_COLOR.light,
            borderColor: MISTRAL_COLOR.border,
            borderWidth: 2,
            pointBackgroundColor: MISTRAL_COLOR.border,
            pointRadius: 3,
          },
        ],
      },
      options: {
        scales: {
          r: {
            min: 0, max: 5,
            ticks: { stepSize: 1, color: '#64748b', backdropColor: 'transparent', font: { size: 9 } },
            grid: { color: '#334155' },
            pointLabels: { color: '#94a3b8', font: { size: 10 } },
            angleLines: { color: '#334155' },
          }
        },
        plugins: { legend: { display: false } },
        responsive: true,
        maintainAspectRatio: false,
      }
    });
    perPromptCharts.push(chart);
  }
}

// ── All Evaluators Radar ────────────────────────────────
function renderAllRadar() {
  const datasets = Object.entries(allData).map(([name, data]) => ({
    label: name,
    data: CRITERIA.map(c => criteriaAvg(data, c)),
    backgroundColor: EVALUATOR_COLORS[name].light,
    borderColor: EVALUATOR_COLORS[name].border,
    borderWidth: 2,
    pointBackgroundColor: EVALUATOR_COLORS[name].border,
    pointRadius: 4,
  }));

  new Chart(document.getElementById('allRadarChart'), {
    type: 'radar',
    data: { labels: CRITERIA_SHORT, datasets },
    options: {
      scales: {
        r: {
          min: 0, max: 5,
          ticks: { stepSize: 1, color: '#64748b', backdropColor: 'transparent' },
          grid: { color: '#334155' },
          pointLabels: { color: '#cbd5e1', font: { size: 12 } },
          angleLines: { color: '#334155' },
        }
      },
      plugins: {
        legend: { labels: { color: '#cbd5e1', usePointStyle: true, pointStyle: 'circle' } }
      },
      responsive: true,
      maintainAspectRatio: true,
    }
  });
}

// ── Init ─────────────────────────────────────────────────
loadData().then(() => {
  renderHeader();
  renderSummary();
  renderRadar();
  renderDiffChart();
  renderBarChart();
  renderDistribution();
  renderDiffHeatmap();
  renderHeatmapTabs();
  renderHeatmap();
  renderPerPrompt();
  renderAllRadar();
});
</script>

</body>
</html>
